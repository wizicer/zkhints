---
import Layout from "../layouts/Layout.astro";
import { glossaryCategories, references } from "../data/glossary";
import References from "../components/References.astro";
---

<Layout id="glossary">
  <div class="container mx-auto px-4 py-8">
    <!-- Quick Navigation -->
    <div class="mb-6 flex flex-wrap gap-2 justify-center">
      {
        glossaryCategories.map((category) => (
          <a
            href={`#${category.id}`}
            class="inline-flex items-center px-3 py-1.5 bg-white rounded-full shadow-sm hover:shadow-md transition-all text-sm border border-gray-200 hover:border-indigo-300 hover:bg-indigo-50"
          >
            <span class="mr-1.5">{category.emoji}</span>
            <span class="text-gray-700">{category.title}</span>
          </a>
        ))
      }
    </div>

    <!-- Search Box -->
    <div class="mb-8 max-w-md mx-auto">
      <div class="relative">
        <input
          type="text"
          id="search-input"
          placeholder="Search terms..."
          class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-sm"
        />
        <svg
          class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
    </div>

    <!-- Glossary Categories -->
    {
      glossaryCategories.map((category) => (
        <div class="mb-8 category-section" id={category.id}>
          <div class="flex items-center gap-2 mb-4 pb-2 border-b-2 border-indigo-200">
            <span class="text-xl">{category.emoji}</span>
            <h2 class="text-lg font-bold text-gray-800">{category.title}</h2>
            <span class="text-xs text-gray-500">({category.terms.length} terms)</span>
          </div>

          <div class="overflow-x-auto">
            <table class="min-w-full bg-white rounded-lg shadow-sm border border-gray-100">
              <thead>
                <tr class="bg-gray-50 text-gray-600 text-xs uppercase">
                  <th class="py-2 px-4 text-left font-semibold w-48">Term</th>
                  <th class="py-2 px-4 text-left font-semibold">Definition</th>
                  <th class="py-2 px-4 text-left font-semibold w-40">Related</th>
                </tr>
              </thead>
              <tbody class="text-sm">
                {category.terms.map((term, idx) => (
                  <tr
                    class={`term-row border-b border-gray-100 hover:bg-indigo-50/30 ${idx % 2 === 0 ? "bg-white" : "bg-gray-50/50"}`}
                    data-term={term.term.toLowerCase()}
                    data-abbreviation={term.abbreviation?.toLowerCase() || ""}
                    data-definition={term.definition.toLowerCase()}
                  >
                    <td class="py-3 px-4 align-top">
                      <div class="font-semibold text-gray-800">{term.term}</div>
                      {term.abbreviation && (
                        <div class="text-xs text-indigo-600 font-mono mt-0.5">{term.abbreviation}</div>
                      )}
                    </td>
                    <td class="py-3 px-4 text-gray-700 leading-relaxed">{term.definition}</td>
                    <td class="py-3 px-4 align-top">
                      {term.relatedTerms && term.relatedTerms.length > 0 && (
                        <div class="flex flex-wrap gap-1">
                          {term.relatedTerms.map((related) => (
                            <span class="related-term text-xs bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded cursor-pointer hover:bg-indigo-100 hover:text-indigo-700" data-search={related}>
                              {related}
                            </span>
                          ))}
                        </div>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      ))
    }

    <!-- References -->
    <References references={references} />
  </div>
</Layout>

<style>
  html {
    scroll-behavior: smooth;
  }

  :target {
    scroll-margin-top: 2rem;
  }

  .term-row.hidden-by-search {
    display: none;
  }

  .category-section.hidden-by-search {
    display: none;
  }

  .term-row.search-match {
    background-color: #eef2ff !important;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Related term search
    const relatedTerms = document.querySelectorAll(".related-term");
    relatedTerms.forEach((el) => {
      el.addEventListener("click", () => {
        const searchTerm = el.getAttribute("data-search");
        const searchInput = document.getElementById("search-input") as HTMLInputElement;
        if (searchInput && searchTerm) {
          searchInput.value = searchTerm;
          searchInput.dispatchEvent(new Event("input"));
          searchInput.scrollIntoView({ behavior: "smooth", block: "center" });
        }
      });
    });

    // Search functionality
    const searchInput = document.getElementById("search-input") as HTMLInputElement;
    if (searchInput) {
      searchInput.addEventListener("input", () => {
        const query = searchInput.value.toLowerCase().trim();
        const categories = document.querySelectorAll(".category-section");
        const termRows = document.querySelectorAll(".term-row");

        if (query === "") {
          termRows.forEach((row) => {
            row.classList.remove("hidden-by-search", "search-match");
          });
          categories.forEach((cat) => {
            cat.classList.remove("hidden-by-search");
          });
          return;
        }

        categories.forEach((category) => {
          const rows = category.querySelectorAll(".term-row");
          let hasVisibleRow = false;

          rows.forEach((row) => {
            const term = row.getAttribute("data-term") || "";
            const abbr = row.getAttribute("data-abbreviation") || "";
            const def = row.getAttribute("data-definition") || "";

            if (term.includes(query) || abbr.includes(query) || def.includes(query)) {
              row.classList.remove("hidden-by-search");
              row.classList.add("search-match");
              hasVisibleRow = true;
            } else {
              row.classList.add("hidden-by-search");
              row.classList.remove("search-match");
            }
          });

          if (hasVisibleRow) {
            category.classList.remove("hidden-by-search");
          } else {
            category.classList.add("hidden-by-search");
          }
        });
      });
    }
  });
</script>
