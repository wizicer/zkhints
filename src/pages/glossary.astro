---
import Layout from "../layouts/Layout.astro";
import { glossaryCategories, references } from "../data/glossary";
import References from "../components/References.astro";

// Helper to create URL-friendly anchor from term
const toAnchor = (term: string) => term.toLowerCase().replace(/[^a-z0-9]+/g, "-").replace(/(^-|-$)/g, "");
---

<Layout id="glossary">
  <div class="container mx-auto px-4 py-8">
    <!-- Quick Navigation -->
    <div class="mb-6 flex flex-wrap gap-2 justify-center">
      {
        glossaryCategories.map((category) => (
          <a
            href={`#${category.id}`}
            class="inline-flex items-center px-3 py-1.5 bg-white rounded-full shadow-sm hover:shadow-md transition-all text-sm border border-gray-200 hover:border-indigo-300 hover:bg-indigo-50"
          >
            <span class="mr-1.5">{category.emoji}</span>
            <span class="text-gray-700">{category.title}</span>
          </a>
        ))
      }
    </div>

    <!-- Search Box -->
    <div class="mb-8 max-w-md mx-auto">
      <div class="relative">
        <input
          type="text"
          id="search-input"
          placeholder="Search terms..."
          class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none text-sm"
        />
        <svg
          class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
    </div>

    <!-- Glossary Categories -->
    {
      glossaryCategories.map((category) => (
        <section class="mb-10 category-section" id={category.id}>
          <div class="flex items-center gap-2 mb-5 pb-2 border-b border-gray-200">
            <span class="text-xl">{category.emoji}</span>
            <h2 class="text-lg font-bold text-gray-800">{category.title}</h2>
          </div>

          <dl class="space-y-4">
            {category.terms.map((term) => {
              const anchor = toAnchor(term.term);
              return (
                <div
                  class="term-entry group"
                  id={anchor}
                  data-term={term.term.toLowerCase()}
                  data-abbreviation={term.abbreviation?.toLowerCase() || ""}
                  data-definition={term.definition.toLowerCase()}
                >
                  <dt class="flex items-baseline gap-2 mb-1">
                    <a href={`#${anchor}`} class="anchor-link text-gray-300 hover:text-indigo-500 opacity-0 group-hover:opacity-100 transition-opacity">#</a>
                    <span class="text-base font-semibold text-gray-900">{term.term}</span>
                    {term.abbreviation && (
                      <span class="text-sm text-indigo-600 font-mono">({term.abbreviation})</span>
                    )}
                  </dt>
                  <dd class="pl-5 text-gray-700 text-sm leading-relaxed">
                    {term.definition}
                    {term.relatedTerms && term.relatedTerms.length > 0 && (
                      <span class="inline-flex flex-wrap items-center gap-1 ml-2">
                        <span class="text-gray-400">→</span>
                        {term.relatedTerms.map((related, i) => (
                          <>
                            <a
                              href={`#${toAnchor(related)}`}
                              class="text-indigo-600 hover:text-indigo-800 hover:underline"
                            >
                              {related}
                            </a>
                            {i < term.relatedTerms!.length - 1 && <span class="text-gray-300">·</span>}
                          </>
                        ))}
                      </span>
                    )}
                  </dd>
                </div>
              );
            })}
          </dl>
        </section>
      ))
    }

    <!-- References -->
    {references && references.length > 0 && <References references={references} />}
  </div>
</Layout>

<style>
  html {
    scroll-behavior: smooth;
  }

  :target {
    scroll-margin-top: 2rem;
  }

  .term-entry:target {
    background: linear-gradient(90deg, #eef2ff 0%, transparent 100%);
    border-radius: 0.25rem;
    padding: 0.5rem;
    margin: -0.5rem;
  }

  .term-entry:target .anchor-link {
    opacity: 1;
    color: #6366f1;
  }

  .term-entry.hidden-by-search {
    display: none;
  }

  .category-section.hidden-by-search {
    display: none;
  }

  .term-entry.search-match {
    background: linear-gradient(90deg, #fef3c7 0%, transparent 100%);
    border-radius: 0.25rem;
    padding: 0.5rem;
    margin: -0.5rem;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Search functionality
    const searchInput = document.getElementById("search-input") as HTMLInputElement;
    if (searchInput) {
      searchInput.addEventListener("input", () => {
        const query = searchInput.value.toLowerCase().trim();
        const categories = document.querySelectorAll(".category-section");
        const termEntries = document.querySelectorAll(".term-entry");

        if (query === "") {
          termEntries.forEach((entry) => {
            entry.classList.remove("hidden-by-search", "search-match");
          });
          categories.forEach((cat) => {
            cat.classList.remove("hidden-by-search");
          });
          return;
        }

        categories.forEach((category) => {
          const entries = category.querySelectorAll(".term-entry");
          let hasVisibleEntry = false;

          entries.forEach((entry) => {
            const term = entry.getAttribute("data-term") || "";
            const abbr = entry.getAttribute("data-abbreviation") || "";
            const def = entry.getAttribute("data-definition") || "";

            if (term.includes(query) || abbr.includes(query) || def.includes(query)) {
              entry.classList.remove("hidden-by-search");
              entry.classList.add("search-match");
              hasVisibleEntry = true;
            } else {
              entry.classList.add("hidden-by-search");
              entry.classList.remove("search-match");
            }
          });

          if (hasVisibleEntry) {
            category.classList.remove("hidden-by-search");
          } else {
            category.classList.add("hidden-by-search");
          }
        });
      });
    }
  });
</script>
