---
import Layout from "../../layouts/Layout.astro";
import { newsData } from "../../data/daily/index";
import { Image } from "astro:assets";

// Import avatars for each category
import paperImg from "../../assets/hinta/paper.png";
import newsImg from "../../assets/hinta/news.png";
import applicationImg from "../../assets/hinta/application.png";
import eventsImg from "../../assets/hinta/events.png";
import dslImg from "../../assets/hinta/dsl.png";
import bugImg from "../../assets/hinta/bug.png";
import gnarkImg from "../../assets/hinta/gnark.png";
import researchImg from "../../assets/hinta/research.png";

// Category to avatar mapping (deterministic)
const categoryAvatars: Record<string, any> = {
  '论文': paperImg,
  '新闻': newsImg,
  '开源': applicationImg,
  '视频': eventsImg,
  '博客': dslImg,
  '活动': eventsImg,
  '工具': gnarkImg,
  '应用': applicationImg,
  '信息': newsImg,
  '漏洞': bugImg,
};

// Default avatar for unknown categories
const defaultAvatar = researchImg;

interface PathItem {
  params: { month: string };
  props: {
    monthData: typeof newsData;
    monthKey: string;
  };
}

export function getStaticPaths() {
  const paths: PathItem[] = [];
  
  // Group news by year-month
  const monthGroups = newsData.reduce((acc, item) => {
    const monthKey = `${item.year}-${item.month}`;
    if (!acc[monthKey]) {
      acc[monthKey] = [];
    }
    acc[monthKey].push(item);
    return acc;
  }, {} as Record<string, typeof newsData>);

  // Create paths for each month
  Object.entries(monthGroups).forEach(([monthKey, data]) => {
    paths.push({
      params: { month: monthKey },
      props: {
        monthData: data.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()),
        monthKey,
      },
    });
  });

  return paths;
}

const { monthData, monthKey } = Astro.props;
const [year, month] = monthKey.split('-');

// Get deterministic avatar based on project type
const getAvatarForType = (type: string) => {
  return categoryAvatars[type] || defaultAvatar;
};

const monthNames = {
  en: ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'],
  zh: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月']
};

const getMonthName = (monthNum: string, lang: 'en' | 'zh') => {
  return monthNames[lang][parseInt(monthNum) - 1];
};

// Category colors and labels from textGenerator.js
const typeColors: Record<string, string> = {
  '论文': 'bg-blue-100 text-blue-800 border-blue-300',
  '新闻': 'bg-gray-100 text-gray-800 border-gray-300',
  '开源': 'bg-green-100 text-green-800 border-green-300',
  '视频': 'bg-red-100 text-red-800 border-red-300',
  '博客': 'bg-yellow-100 text-yellow-800 border-yellow-300',
  '活动': 'bg-pink-100 text-pink-800 border-pink-300',
  '工具': 'bg-purple-100 text-purple-800 border-purple-300',
  '应用': 'bg-indigo-100 text-indigo-800 border-indigo-300',
  '信息': 'bg-teal-100 text-teal-800 border-teal-300',
  '漏洞': 'bg-orange-100 text-orange-800 border-orange-300',
};

const typeLabels: Record<'zh' | 'en', Record<string, string>> = {
  zh: {
    '论文': '论文',
    '新闻': '新闻',
    '开源': '开源',
    '视频': '视频',
    '博客': '博客',
    '活动': '活动',
    '工具': '工具',
    '应用': '应用',
    '信息': '信息',
    '漏洞': '漏洞',
  },
  en: {
    '论文': 'Paper',
    '新闻': 'News',
    '开源': 'OSS',
    '视频': 'Video',
    '博客': 'Blog',
    '活动': 'Event',
    '工具': 'Tool',
    '应用': 'App',
    '信息': 'News',
    '漏洞': 'Vulnerability',
  }
};

// Helper function to get text content with language fallback
const getText = (content: any, lang: 'en' | 'zh'): string => {
  if (!content) return '';
  if (typeof content === 'string') return content; // Old format, default to zh
  if (typeof content === 'object') {
    return content[lang] || content.zh || content.en || '';
  }
  return '';
};

---

<Layout title={`Daily Digest - ${year}-${month}`}>
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- Back to Home Button (Top) -->
    <div class="mb-6">
      <a
        href="/daily"
        class="inline-flex items-center px-4 py-2 text-gray-600 hover:text-indigo-600 transition-colors font-medium"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5 mr-2"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M10 19l-7-7m0 0l7-7m-7 7h18"
          ></path>
        </svg>
        <span data-lang-en>Back to Archive</span>
        <span data-lang-zh class="hidden">返回归档</span>
      </a>
    </div>
    <!-- Header with Language Toggle -->
    <div class="mb-8 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-8 shadow-lg">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <h1 class="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-indigo-600 to-purple-600 mb-2">
            <span data-lang-en>Daily Digest</span>
            <span data-lang-zh class="hidden">每日摘要</span>
          </h1>
          <p class="text-2xl text-gray-700">
            <span data-lang-en>{getMonthName(month, 'en')} {year}</span>
            <span data-lang-zh class="hidden">{year} 年 {getMonthName(month, 'zh')}</span>
          </p>
        </div>
        
        <!-- Language Toggle -->
        <div class="flex items-center gap-3 bg-white rounded-lg shadow-md p-2">
          <button
            id="lang-en"
            class="lang-toggle px-4 py-2 rounded-md font-medium transition-all duration-200 bg-indigo-600 text-white"
            data-lang="en"
          >
            English
          </button>
          <button
            id="lang-zh"
            class="lang-toggle px-4 py-2 rounded-md font-medium transition-all duration-200 text-gray-600 hover:bg-gray-100"
            data-lang="zh"
          >
            中文
          </button>
        </div>
      </div>
    </div>

    <!-- Timeline -->
    <div class="relative">
      <!-- Timeline line -->
      <div class="absolute left-8 top-0 bottom-0 w-0.5 bg-gradient-to-b from-indigo-200 via-purple-200 to-pink-200"></div>

      {monthData.map((dayItem, dayIndex) => (
        <div class="mb-12 relative">
          <!-- Date Badge -->
          <div class="flex items-center mb-6">
            <div class="relative z-10 flex items-center justify-center w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full shadow-lg">
              <div class="text-center">
                <div class="text-white text-xl font-bold">{dayItem.day}</div>
                <div class="text-white text-xs opacity-90">
                  <span data-lang-en>{dayItem.weekday.en.slice(0, 3)}</span>
                  <span data-lang-zh class="hidden">{dayItem.weekday.zh.slice(2)}</span>
                </div>
              </div>
            </div>
            <div class="ml-4 text-gray-500 text-sm">
              {dayItem.year}-{dayItem.month}-{dayItem.day}
            </div>
          </div>

          <!-- Projects for this day -->
          <div class="ml-24 space-y-6">
            {dayItem.projects.map((project, projectIndex) => {
              const avatar = getAvatarForType(project.type);
              
              return (
                <div class="bg-white rounded-xl shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden border border-gray-100 hover:border-indigo-200">
                  <div class="p-6">
                    <!-- Project Header -->
                    <div class="flex items-start gap-4 mb-4">
                      <div class="flex-shrink-0">
                        <Image
                          src={avatar}
                          alt="Project avatar"
                          class="w-16 h-16 rounded-lg shadow-sm"
                        />
                      </div>
                      
                      <div class="flex-1 min-w-0">
                        <div class="flex items-start justify-between gap-2 mb-2">
                          <a
                            href={project.url}
                            target="_blank"
                            rel="noopener noreferrer"
                            class="text-xl font-bold text-gray-900 hover:text-indigo-600 transition-colors line-clamp-2"
                          >
                            {project.name}
                          </a>
                          <span class={`flex-shrink-0 px-3 py-1 text-xs font-semibold rounded-full border ${typeColors[project.type] || 'bg-gray-100 text-gray-800 border-gray-300'}`}>
                            <span data-lang-en>{typeLabels.en[project.type] || project.type}</span>
                            <span data-lang-zh class="hidden">{typeLabels.zh[project.type] || project.type}</span>
                          </span>
                        </div>
                        
                        <!-- Tags -->
                        <div class="flex flex-wrap gap-2 mb-3">
                          {project.tags.map((tag) => (
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-gray-100 text-gray-700">
                              {typeof tag === 'string' ? tag : (
                                <>
                                  <span data-lang-en>{tag.en}</span>
                                  <span data-lang-zh class="hidden">{tag.zh}</span>
                                </>
                              )}
                            </span>
                          ))}
                        </div>
                      </div>
                    </div>

                    <!-- Summary -->
                    <div class="mb-4 p-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-lg">
                      <p class="text-gray-800 leading-relaxed twitter-content">
                        <span data-lang-en>{getText(project.summary, 'en').replace(/{{name}}/g, '')}</span>
                        <span data-lang-zh class="hidden">{getText(project.summary, 'zh').replace(/{{name}}/g, '')}</span>
                      </p>
                    </div>

                    <!-- Notes -->
                    {project.notes && (
                      <div class="space-y-2">
                        <h4 class="text-sm font-semibold text-gray-700 mb-2">
                          <span data-lang-en>Key Points:</span>
                          <span data-lang-zh class="hidden">要点：</span>
                        </h4>
                        <ul class="space-y-1.5">
                          {(() => {
                            const notesEn = typeof project.notes === 'object' && Array.isArray(project.notes.en) ? project.notes.en : (Array.isArray(project.notes) ? project.notes : []);
                            const notesZh = typeof project.notes === 'object' && Array.isArray(project.notes.zh) ? project.notes.zh : (Array.isArray(project.notes) ? project.notes : []);
                            const maxLength = Math.max(notesEn.length, notesZh.length);
                            
                            return Array.from({ length: maxLength }).map((_, noteIndex) => (
                              <li class="flex items-start gap-2 text-sm text-gray-600">
                                <span class="text-indigo-500 mt-1 flex-shrink-0">•</span>
                                <span class="twitter-content">
                                  <span data-lang-en>{notesEn[noteIndex] || ''}</span>
                                  <span data-lang-zh class="hidden">{notesZh[noteIndex] || ''}</span>
                                </span>
                              </li>
                            ));
                          })()}
                        </ul>
                      </div>
                    )}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      ))}
    </div>

  </div>
</Layout>

<script>
  // Convert Twitter handles to links
  const convertTwitterHandles = () => {
    document.querySelectorAll('.twitter-content').forEach(el => {
      const element = el as HTMLElement;
      element.innerHTML = element.innerHTML.replace(
        /@([A-Za-z0-9_]+)/g,
        '<a href="https://x.com/$1" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 font-medium">@$1</a>'
      );
    });
  };

  // Language toggle functionality
  const initLanguageToggle = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const savedLang = urlParams.get('lang') || 'en';
    
    const setLanguage = (lang: string) => {
      // Update URL
      const url = new URL(window.location.href);
      url.searchParams.set('lang', lang);
      window.history.replaceState({}, '', url);
      
      // Toggle visibility
      document.querySelectorAll('[data-lang-en]').forEach(el => {
        (el as HTMLElement).classList.toggle('hidden', lang !== 'en');
      });
      document.querySelectorAll('[data-lang-zh]').forEach(el => {
        (el as HTMLElement).classList.toggle('hidden', lang !== 'zh');
      });
      
      // Update button styles
      document.querySelectorAll('.lang-toggle').forEach(btn => {
        const button = btn as HTMLButtonElement;
        const btnLang = button.dataset.lang;
        if (btnLang === lang) {
          button.classList.add('bg-indigo-600', 'text-white');
          button.classList.remove('text-gray-600', 'hover:bg-gray-100');
        } else {
          button.classList.remove('bg-indigo-600', 'text-white');
          button.classList.add('text-gray-600', 'hover:bg-gray-100');
        }
      });
    };
    
    // Set initial language
    setLanguage(savedLang);
    
    // Add click handlers
    document.querySelectorAll('.lang-toggle').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const lang = (e.target as HTMLButtonElement).dataset.lang;
        if (lang) setLanguage(lang);
      });
    });
  };
  
  // Initialize on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      convertTwitterHandles();
      initLanguageToggle();
    });
  } else {
    convertTwitterHandles();
    initLanguageToggle();
  }
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
